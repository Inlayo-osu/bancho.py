{% extends "base.html" %}
{% block title %}Forgot Password{% endblock %}

{% block description %}Reset your Inlayo password{% endblock %}

{% block og_title %}Forgot Password | Inlayo{% endblock %}
{% block og_description %}Reset your password and regain access to your Inlayo account{% endblock %}
{% block og_image %}https://osu.{{ domain() }}/static/favicon/android-chrome-256x256.png{% endblock %}

{% block header %}
<style>
.auth-page {
  min-height: 100vh;
  display: flex;
  align-items: center;
  justify-content: center;
  padding: 2rem 1rem;
  background: linear-gradient(135deg, #0f172a 0%, #1e293b 50%, #0f172a 100%);
  position: relative;
  overflow: hidden;
}
.auth-page::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: radial-gradient(circle at 50% 0%, rgba(236, 72, 153, 0.15) 0%, transparent 60%);
  z-index: 0;
}
.auth-card {
  background: rgba(30, 41, 59, 0.9);
  backdrop-filter: blur(20px);
  border: 1px solid rgba(148, 163, 184, 0.15);
  border-radius: var(--radius-xl);
  padding: 3rem;
  max-width: 480px;
  width: 100%;
  box-shadow: 0 20px 60px rgba(0, 0, 0, 0.4);
  position: relative;
  z-index: 1;
  animation: auth-appear 0.6s ease-out;
}
@keyframes auth-appear {
  from { opacity: 0; transform: translateY(30px); }
  to { opacity: 1; transform: translateY(0); }
}
.forgot-header {
  text-align: center;
  margin-bottom: 2.5rem;
}
.forgot-icon {
  width: 80px;
  height: 80px;
  margin: 0 auto 1.5rem;
  background: linear-gradient(135deg, var(--accent-pink), var(--accent-purple));
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  animation: icon-float 3s ease-in-out infinite;
}
@keyframes icon-float {
  0%, 100% { transform: translateY(0); }
  50% { transform: translateY(-10px); }
}
.forgot-icon i {
  font-size: 2.5rem;
  color: white;
}
.forgot-header .title {
  font-size: 2rem;
  font-weight: 700;
  color: var(--text-primary);
  margin-bottom: 0.5rem;
}
.forgot-header .subtitle {
  color: var(--text-muted);
  font-size: 1rem;
}
.auth-form .control {
  margin-bottom: 1.5rem;
  position: relative;
}
.input-group {
  display: flex;
  gap: 0.75rem;
  align-items: stretch;
}
.input-group-flex {
  flex: 1;
  position: relative;
}
.auth-form .input {
  width: 100%;
  padding: 0.875rem 1rem 0.875rem 3rem;
  background: rgba(15, 23, 42, 0.6);
  border: 1px solid rgba(148, 163, 184, 0.2);
  border-radius: var(--radius-md);
  color: var(--text-primary);
  font-size: 1rem;
  transition: all 0.3s ease;
}
.auth-form .input:focus {
  outline: none;
  border-color: var(--accent-pink);
  background: rgba(15, 23, 42, 0.8);
  box-shadow: 0 0 0 3px rgba(236, 72, 153, 0.1);
}
.auth-form .icon {
  position: absolute;
  left: 1rem;
  top: 50%;
  transform: translateY(-50%);
  color: var(--text-muted);
  pointer-events: none;
}
.input-group .ui-button {
  white-space: nowrap;
  padding: 0.875rem 1.5rem;
}
.dialog {
  text-align: center;
  color: var(--text-muted);
  font-size: 0.95rem;
}
.dialog a {
  color: var(--accent-pink);
  text-decoration: none;
  font-weight: 600;
  transition: color 0.2s ease;
}
.dialog a:hover {
  color: var(--accent-purple);
}
</style>
{% endblock %}

{% block content %}

<script>
  async function sendVerificationEmail() {
    const emailRegex = /^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$/;
    const emailInput = document.getElementById("email");
    const email = emailInput.value.trim().toLowerCase();
    const sendBtn = document.getElementById("send-btn");
    const submitBtn = document.getElementById("submit-btn");
    sendBtn.classList.add("is-loading"); // Add loading animation to button
    sendBtn.disabled = true;

    if (!email | !emailRegex.test(email)) {
      sendBtn.classList.remove("is-loading");
      sendBtn.disabled = false;
      return alert("Please enter a valid email address.");
    }

    const formData = new FormData();
    formData.append("email", email);
    try {
      const response = await fetch("/forgot_emailchecksend", {
        method: "POST",
        body: formData,
      });

      if (!response.ok) {
        throw new Error("Server responded with an error.");
      }

      const data = await response.text();
      if (data === "sent") {
        submitBtn.disabled = false;
        alert("Verification email sent successfully!");
      } else if (!isNaN(data)) {
        submitBtn.disabled = false;
        alert(
          `Verification email has been sent. You can try again in ${data} seconds.`
        );
      } else if (data === "404 Not Found") {
        sendBtn.disabled = false; // Restore button only on request failure since it was disabled when loading animation was added
        alert(`Not Found username From ${email}`);
      } else if (data.startsWith("ERROR | ")) {
        sendBtn.disabled = false; // Restore button only on request failure since it was disabled when loading animation was added
        alert(`ERROR! report admin plz \n\n${data}`);
      } else {
        sendBtn.disabled = false; // Restore button only on request failure since it was disabled when loading animation was added
        alert("Failed to send verification email.");
      }
    } catch (error) {
      console.error("Error:", error);
      alert("An error occurred. Please try again later.");
    } finally {
      sendBtn.classList.remove("is-loading");
      sendBtn.disabled = false;
    }
  }
</script>

<div class="auth-page">
  <div class="auth-card">
    <div class="forgot-header">
      <div class="forgot-icon">
        <i class="fas fa-key"></i>
      </div>
      <h1 class="title">Forgot Password</h1>
      <p class="subtitle">Enter your email to reset your password</p>
    </div>
    <form action="/forgot" method="post" class="auth-form">
      <div class="control">
        <div class="input-group">
          <div class="input-group-flex">
            <input id="email" type="email" name="email" placeholder="e.g. {{ SenderEmail }}" class="input" autocomplete="email" required />
            <span class="icon is-left">
              <i class="fa fa-envelope"></i>
            </span>
          </div>
          <button id="send-btn" type="button" class="ui-button ui-button-pink" onclick="sendVerificationEmail()">
            Send
          </button>
        </div>
      </div>
      
      <div class="control">
        <input id="verification" type="text" name="emailkey" placeholder="Email Verification Code" class="input" required />
        <span class="icon is-left">
          <i class="fa fa-shield-alt"></i>
        </span>
      </div>
      
      <div class="control">
        <input id="pass" type="password" name="new_password" placeholder="New Password" class="input" autocomplete="new-password" required />
        <span class="icon is-left">
          <i class="fa fa-lock"></i>
        </span>
      </div>
      
      <div class="control">
        <input id="confirm" type="password" name="repeat_password" placeholder="Confirm New Password" class="input" autocomplete="new-password" required />
        <span class="icon is-left">
          <i class="fa fa-lock"></i>
        </span>
      </div>
      
      <div class="dialog mb-4">
        Remember your password? <a href="/login">Login</a>
      </div>
      
      {% if not captchaKey() == 'changeme' %}
      <div class="control">
        <div class="h-captcha captcha-center" data-sitekey="{{ captchaKey() }}" data-theme="dark"></div>
      </div>
      {% endif %}
      
      <button id="submit-btn" type="submit" class="ui-button ui-button-pink ui-button-large ui-button-full" disabled>
        Submit
      </button>
    </form>
  </div>
</div>

{% if flash %}
<div class="paper-snackbar is-{{ status }} snackbar-visible">{{ flash }}</div>
{% endif %} {% if not captchaKey() == 'changeme' %}
<script src="https://hcaptcha.com/1/api.js" async defer></script>
{% endif %} {% endblock %}
