{% extends 'base.html' %}
{% block title %}Reset Password{% endblock %}

{% block header %}
{% set page_title = 'Reset Password - ' + appName() %}
{% set page_desc = 'Create a new password for your account' %}
{% set page_image = 'https://' + domain() + '/static/images/logo.png' %}

<meta name="description" content="{{ page_desc }}">
<meta property="og:title" content="{{ page_title }}">
<meta property="og:description" content="{{ page_desc }}">
<meta property="og:image" content="{{ page_image }}">
<meta property="og:url" content="https://{{ domain() }}/reset">
<meta property="og:type" content="website">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="{{ page_title }}">
<meta name="twitter:description" content="{{ page_desc }}">
<meta name="twitter:image" content="{{ page_image }}">

<link rel="stylesheet" href="/static/css/pages/auth.css">
<script src="/static/js/asserts/vue.js"></script>
<script src="https://cdn.jsdelivr.net/npm/axios@1.6.0/dist/axios.min.js"></script>
{% endblock %}

{% block content %}
<div class="main-block is-marginless is-paddingless is-auth" id="reset-app">
    <div class="columns pm-reset is-weeb">
        <div class="column title-block">
            <h1 class="title" id="regtitle">Reset Password</h1>
        </div>
    </div>
    <div class="columns pm-reset flex-lcenter is-block">
        <div class="box">
            <div class="login-bg"></div>
            <form @submit.prevent="resetPassword" class="form-content">
                <div class="field">
                    <label for="password" class="label">New Password</label>
                    <div class="control has-icons-left">
                        <input id="password" v-model="password" class="input" type="password" placeholder="*************" minlength="8" maxlength="32" autocomplete="new-password" required>
                        <span class="icon is-small is-left">
                            <i class="fa fa-lock"></i>
                        </span>
                    </div>
                </div>
                <div class="field">
                    <label for="confirmPassword" class="label">Confirm Password</label>
                    <div class="control has-icons-left">
                        <input id="confirmPassword" v-model="confirmPassword" class="input" type="password" placeholder="*************" minlength="8" maxlength="32" autocomplete="new-password" required>
                        <span class="icon is-small is-left">
                            <i class="fa fa-lock"></i>
                        </span>
                    </div>
                </div>
                <div class="mt-5"></div>
                <div class="dialog">
                    Remember your password? <a href="/login">Login</a>
                </div>
                <div class="field">
                    <button type="submit" class="button is-primary" :disabled="loading">
                        <% loading ? 'Resetting...' : 'Reset Password' %>
                    </button>
                </div>
                <div v-if="message" :class="'notification ' + (messageType === 'success' ? 'is-success' : 'is-danger')" style="margin-top: 1rem;">
                    <% message %>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
new Vue({
    el: '#reset-app',
    delimiters: ['<%', '%>'],
    data: {
        password: '',
        confirmPassword: '',
        loading: false,
        message: '',
        messageType: 'error',
        code: new URLSearchParams(window.location.search).get('code')
    },
    methods: {
        async resetPassword() {
            if (this.password !== this.confirmPassword) {
                this.message = 'Passwords do not match';
                this.messageType = 'error';
                return;
            }

            if (this.password.length < 8 || this.password.length > 32) {
                this.message = 'Password must be 8-32 characters';
                this.messageType = 'error';
                return;
            }

            this.loading = true;
            this.message = '';

            try {
                const formData = new FormData();
                formData.append('code', this.code);
                formData.append('password', this.password);

                const response = await axios.post('/reset-password', formData);

                if (response.data.status === 'success') {
                    this.message = 'Password reset successfully! Redirecting to login...';
                    this.messageType = 'success';
                    setTimeout(() => {
                        window.location.href = '/login';
                    }, 2000);
                } else {
                    this.message = response.data.message || 'Reset failed';
                    this.messageType = 'error';
                }
            } catch (error) {
                this.message = 'An error occurred. Please try again.';
                this.messageType = 'error';
            } finally {
                this.loading = false;
            }
        }
    },
    mounted() {
        if (!this.code) {
            this.message = 'Invalid or missing reset code';
            this.messageType = 'error';
        }
    }
});
</script>
{% endblock %}
