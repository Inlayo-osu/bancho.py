{% extends 'base.html' %}
{% block title %} Reset Password {% endblock %}

{% block header %}
<link rel="stylesheet" href="/static/css/pages/auth.css">
<script src="/static/js/asserts/vue.js"></script>
<script src="/static/js/asserts/axios.js"></script>
{% endblock %}

{% block content %}
<div class="main-block is-marginless is-paddingless is-auth" id="reset-app">
    <div class="columns pm-reset is-weeb">
        <div class="column title-block">
            <div class="titlewithsub">
                <h1 class="title is-left">Reset Password</h1>
                <h2 class="subtitle">Enter your new password</h2>
            </div>
        </div>
        <div class="column icon-block">
            <i class="fas fa-key is-headericon"></i>
        </div>
    </div>
    <div class="columns pm-reset flex-lcenter is-block">
        <div class="box is-padding">
            <form @submit.prevent="resetPassword">
                <div class="field">
                    <label class="label">New Password</label>
                    <div class="control has-icons-left">
                        <input v-model="password" class="input" type="password" placeholder="Enter new password" minlength="8" maxlength="32" required>
                        <span class="icon is-small is-left">
                            <i class="fas fa-lock"></i>
                        </span>
                    </div>
                </div>
                <div class="field">
                    <label class="label">Confirm Password</label>
                    <div class="control has-icons-left">
                        <input v-model="confirmPassword" class="input" type="password" placeholder="Confirm new password" minlength="8" maxlength="32" required>
                        <span class="icon is-small is-left">
                            <i class="fas fa-lock"></i>
                        </span>
                    </div>
                </div>
                <div class="field">
                    <div class="control">
                        <button type="submit" class="button is-fullwidth" :disabled="loading">
                            <% loading ? 'Resetting...' : 'Reset Password' %>
                        </button>
                    </div>
                </div>
                <div v-if="message" :class="'notification ' + (messageType === 'success' ? 'is-success' : 'is-danger')">
                    <% message %>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
new Vue({
    el: '#reset-app',
    delimiters: ['<%', '%>'],
    data: {
        password: '',
        confirmPassword: '',
        loading: false,
        message: '',
        messageType: 'error',
        code: new URLSearchParams(window.location.search).get('code')
    },
    methods: {
        async resetPassword() {
            if (this.password !== this.confirmPassword) {
                this.message = 'Passwords do not match';
                this.messageType = 'error';
                return;
            }

            if (this.password.length < 8 || this.password.length > 32) {
                this.message = 'Password must be 8-32 characters';
                this.messageType = 'error';
                return;
            }

            this.loading = true;
            this.message = '';

            try {
                const formData = new FormData();
                formData.append('code', this.code);
                formData.append('password', this.password);

                const response = await axios.post('/reset-password', formData);

                if (response.data.status === 'success') {
                    this.message = 'Password reset successfully! Redirecting to login...';
                    this.messageType = 'success';
                    setTimeout(() => {
                        window.location.href = '/login';
                    }, 2000);
                } else {
                    this.message = response.data.message || 'Reset failed';
                    this.messageType = 'error';
                }
            } catch (error) {
                this.message = 'An error occurred. Please try again.';
                this.messageType = 'error';
            } finally {
                this.loading = false;
            }
        }
    },
    mounted() {
        if (!this.code) {
            this.message = 'Invalid or missing reset code';
            this.messageType = 'error';
        }
    }
});
</script>
{% endblock %}
