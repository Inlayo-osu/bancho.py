{% extends "base.html" %}
{% block title %}Register{% endblock %}

{% block description %}Register on Inlayo{% endblock %}

{% block og_title %}Register | Inlayo{% endblock %}
{% block og_description %}Create a free account and join the Inlayo osu! community today{% endblock %}
{% block og_image %}https://{{ domain() }}/static/favicon/android-chrome-256x256.png{% endblock %}

{% block header %}
<link rel="stylesheet" href="/static/css/pages/auth.css" />
{% endblock %} {% block content %}

<script>
  async function sendVerificationEmail() {
    const emailRegex = /^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$/;
    const emailInput = document.getElementById("email");
    const email = emailInput.value.trim().toLowerCase();
    const sendBtn = document.getElementById("send-btn");
    const registerBtn = document.getElementById("register-btn");
    sendBtn.classList.add("is-loading");
    sendBtn.disabled = true;

    if (!email | !emailRegex.test(email)) {
      sendBtn.classList.remove("is-loading");
      sendBtn.disabled = false;
      return alert("Please enter a valid email address.");
    }

    const formData = new FormData();
    formData.append("user", document.getElementById("user").value);
    formData.append("email", email);
    try {
      const response = await fetch("/register_emailchecksend", {
        method: "POST",
        body: formData,
      });

      if (!response.ok) {
        throw new Error("Server responded with an error.");
      }

      const data = await response.text();
      if (data === "sent") {
        sendBtn.disabled = true;
        registerBtn.disabled = false;
        alert("Verification email sent successfully!");
      } else if (!isNaN(data)) {
        sendBtn.disabled = true;
        registerBtn.disabled = false;
        alert(
          `Verification email has been sent. You can try again in ${data} seconds.`
        );
      } else if (data === "exist") {
        emailInput.value = "";
        sendBtn.disabled = false;
        alert("This email is already registered.");
      } else if (data.startsWith("ERROR | ")) {
        sendBtn.disabled = false;
        alert(`ERROR! report admin plz \n\n${data}`);
      } else {
        sendBtn.disabled = false;
        alert("Failed to send verification email.");
      }
    } catch (error) {
      console.error("Error:", error);
      alert("An error occurred. Please try again later.");
    } finally {
      sendBtn.classList.remove("is-loading");
      sendBtn.disabled = false;
    }
  }
</script>

<div class="main-block is-marginless is-paddingless is-auth">
  <div class="columns pm-reset is-weeb">
    <div class="column title-block">
      <h1 class="title" id="regtitle">Registration</h1>
    </div>
  </div>
  <div class="columns pm-reset flex justify-center is-block">
    <div class="box-standard">
      <div class="login-bg"></div>
      <form action="/register" method="post" class="form-content">
        <div class="form-group">
          <label for="user" class="form-group-label">Username</label>
          <div class="input-with-icon">
            <span class="input-icon">
              <i class="fa fa-user"></i>
            </span>
            <input id="user" type="text" name="username" placeholder="e.g. Inlayo" class="input-base" autocomplete="username"
              required />
          </div>
        </div>
        <div class="form-group">
          <label for="email" class="form-group-label">Email</label>
          <div class="input-group">
            <div class="input-with-icon input-group-flex">
              <span class="input-icon">
                <i class="fa fa-envelope"></i>
              </span>
              <input id="email" type="email" name="email" placeholder="e.g. {{ SenderEmail }}" class="input-base"
                autocomplete="email" required />
            </div>
            <button id="send-btn" type="button" class="btn btn-primary auth-send-btn" onclick="sendVerificationEmail()">
              Send
            </button>
          </div>
        </div>
        <div class="form-group">
          <label for="verification" class="form-group-label">Email Verification</label>
          <div class="input-with-icon">
            <span class="input-icon">
              <i class="fa fa-lock"></i>
            </span>
            <input id="verification" type="text" name="emailkey" placeholder="*************" class="input-base" required />
          </div>
        </div>
        <div class="form-group">
          <label for="pass" class="form-group-label">Password</label>
          <div class="input-with-icon">
            <span class="input-icon">
              <i class="fa fa-lock"></i>
            </span>
            <input id="pass" type="password" name="password" placeholder="*************" class="input-base"
              autocomplete="new-password" required />
          </div>
        </div>
        <div class="form-group">
          <label for="pass" class="form-group-label">Confirm Password</label>
          <div class="input-with-icon">
            <span class="input-icon">
              <i class="fa fa-lock"></i>
            </span>
            <input id="pass" type="password" name="confirm_password" placeholder="*************" class="input-base"
              autocomplete="new-password" required />
          </div>
        </div>
        <div class="mt-5"></div>
        {% if not captchaKey() == 'changeme' %}
        <div class="field">
          <div class="h-captcha captcha-center" data-sitekey="{{ captchaKey() }}" data-theme="dark"></div>
        </div>
        {% endif %}
        <div class="mt-5">
          <button id="register-btn" type="submit" class="btn btn-primary btn-full btn-large" disabled>
            Register
          </button>
        </div>
        <div class="mt-4 dialog auth-dialog-center">
          Already have an account? <a href="/login">Login</a>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- bancho's Ingame Registaration -->
<script>
  const params = new URLSearchParams(location.search);
  document.getElementById("user").value = params.get("username");
  document.getElementById("email").value = params.get("email");
</script>

{% if flash %}
<div class="paper-snackbar is-{{ status }} snackbar-visible">{{ flash }}</div>
{% endif %} {% if not captchaKey() == 'changeme' %}
<script src="https://hcaptcha.com/1/api.js" async defer></script>
{% endif %} {% endblock %}
